Import the code from Pharo for more readability.
Sorry for line-endings.
